#!/usr/bin/env bash
set -Eeou pipefail

if [[ "${CI:-}" == "true" ]]; then
    echo "--- Setting up CI cache directories"

    export CACHE_DIR="/cache"
    export CARGO_HOME="${CACHE_DIR}/cargo"
    export TARGET_CACHE_DIR="${CACHE_DIR}/target"

    # We (almost) always check out fresh, so file mtime is always newer
    export CARGO_BUILD_INCREMENTAL=false

    mkdir -p "$CACHE_DIR" "$CARGO_HOME" "$TARGET_CACHE_DIR"
    ln -sf "$TARGET_CACHE_DIR" target

    cache_avail=$(df --output=avail|sed -n 2p)
    min_cache_avail=$(( 2 * 1024 * 1024 )) # 25%
    if [[ $cache_avail -le $min_cache_avail ]]; then
        echo "Freeing space under /cache"
        rm -rf "${CACHE_DIR:?}/*"
    fi
fi
